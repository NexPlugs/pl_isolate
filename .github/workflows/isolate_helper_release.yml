name: Release isolate_helper

on:
  push:
    branches:
      - main
    paths:
      - 'isolate_helper/**'

permissions:
  contents: write

jobs:
  publish:
    if: ${{ github.actor != 'github-actions[bot]' }}
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Install dependencies
        run: |
          flutter pub get

      - name: Run unit tests
        run: |
          flutter test

      - name: Prepare release artifacts
        id: release
        run: |
          NEW_VERSION=$(dart run tool/release_isolate_helper.dart)
          echo "release_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Commit release changes
        id: commit
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add CHANGELOG.md pubspec.yaml
            git commit -m "chore(isolate_helper): release v${{ steps.release.outputs.release_version }}"
            echo "committed=true" >> $GITHUB_OUTPUT
          else
            echo "committed=false" >> $GITHUB_OUTPUT
          fi

      - name: Push release commit
        if: steps.commit.outputs.committed == 'true'
        run: |
          git push origin HEAD:${GITHUB_REF}

      - name: Create release tag
        if: steps.commit.outputs.committed == 'true'
        run: |
          git tag isolate_helper-v${{ steps.release.outputs.release_version }}
          git push origin isolate_helper-v${{ steps.release.outputs.release_version }}

      - name: Publish isolate_helper to pub.dev
        if: steps.commit.outputs.committed == 'true'
        env:
          PUB_CREDENTIALS: ${{ secrets.PUB_CREDENTIALS }}
        run: |
          if [ -z "$PUB_CREDENTIALS" ]; then
            echo "PUB_CREDENTIALS secret is not set."
            exit 1
          fi
          mkdir -p ~/.config/dart
          printf '%s' "$PUB_CREDENTIALS" > ~/.config/dart/pub-credentials.json
          dart pub publish --force

